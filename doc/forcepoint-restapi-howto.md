# Forcepoint REST API How-To Guide

**Target Audience:** Network Engineers, Security Architects, DevOps Engineers  
**Prerequisites:** Forcepoint NGFW with Security Management Center (SMC), Capirca installed

---

## Table of Contents

1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [Quick Start](#quick-start)
4. [Authentication](#authentication)
5. [Basic API Operations](#basic-api-operations)
6. [Policy Management](#policy-management)
7. [Object Management](#object-management)
8. [Advanced Use Cases](#advanced-use-cases)
9. [Error Handling](#error-handling)
10. [Best Practices](#best-practices)
11. [Troubleshooting](#troubleshooting)

---

## Overview

This guide demonstrates how to use the Forcepoint REST API to deploy firewall policies generated by Capirca. The Forcepoint REST API provides a modern, programmatic interface for managing NGFW configurations through JSON/HTTPS communication.

### Key Benefits

* **Automation**: Integrate firewall management into CI/CD pipelines
* **Consistency**: Ensure policy consistency across multiple firewalls
* **Version Control**: Store policies in Git with full history
* **Scalability**: Manage large-scale deployments efficiently
* **Integration**: Connect with orchestration and monitoring tools

---

## Prerequisites

### System Requirements

* **Forcepoint NGFW**: Version 6.x or 7.x
* **Security Management Center (SMC)**: Version 6.x/7.x with REST API enabled
* **Python**: 3.7+ (for Capirca and SMC SDK)
* **Network Connectivity**: HTTPS access to SMC (port 8082 by default)

### Required Packages

```bash
# Capirca dependencies
pip install absl-py pyyaml ply typing-extensions

# Forcepoint SMC SDK (optional, for Python deployment)
pip install smc-python

# HTTP client for API testing
pip install requests
```

### API Access Configuration

1. **Enable REST API in SMC**:
   - Navigate to **System > Configuration > API**
   - Enable REST API service
   - Configure allowed IP ranges
   - Set API version (v6.x or v7.x)

2. **Create API Credentials**:
   - Generate API key in SMC
   - Assign appropriate permissions
   - Store securely (environment variables recommended)

---

## Quick Start

### Step 1: Create a Simple Capirca Policy

Create a file `web-access.pol`:

```pol
header {
  comment:: "Web Access Policy for Corporate Firewall"
  target:: forcepoint web-access inet json
}

term allow-http-https {
  comment:: "Allow HTTP and HTTPS from internal network"
  source-address:: INTERNAL_NET
  destination-address:: DMZ_WEBSERVERS
  destination-port:: HTTP HTTPS
  protocol:: tcp
  action:: accept
  logging:: true
}

term deny-all {
  comment:: "Deny all other traffic"
  action:: deny
  logging:: true
}
```

### Step 2: Define Network Objects

Create `def/networks.def`:

```
# Network Definitions
INTERNAL_NET = 10.0.0.0/8
DMZ_WEBSERVERS = 192.168.100.0/24
```

Create `def/services.def`:

```
# Service Definitions
HTTP = 80/tcp
HTTPS = 443/tcp
```

### Step 3: Generate Forcepoint Configuration

```bash
# Generate JSON configuration
python capirca/aclgen.py --definitions def/ --output_dir output/ web-access.pol

# Generated file: output/web-access.forcepoint.json
```

### Step 4: Deploy via REST API

```bash
#!/bin/bash
# deploy-policy.sh

SMC_URL="https://smc.example.com:8082"
API_TOKEN="your-api-token-here"
POLICY_FILE="output/web-access.forcepoint.json"

# Deploy the policy
curl -X POST "${SMC_URL}/api/v6/policy" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer ${API_TOKEN}" \
  -d @"${POLICY_FILE}" \
  | jq .
```

---

## Authentication

### API Key Authentication

Forcepoint REST API uses Bearer token authentication:

```python
import requests

SMC_URL = "https://smc.example.com:8082"
API_TOKEN = "your-api-token-here"

headers = {
    'Content-Type': 'application/json',
    'Authorization': f'Bearer {API_TOKEN}'
}

# Test authentication
response = requests.get(f"{SMC_URL}/api/v6/system/info", headers=headers)
print(f"Status: {response.status_code}")
print(f"Response: {response.json()}")
```

### Session-based Authentication (SMC SDK)

```python
from smc import session

# Connect to SMC
session.login(
    url='https://smc.example.com:8082',
    api_key='your-api-key-here'
)

try:
    # Perform operations
    pass
finally:
    session.logout()
```

### Environment Variables

Store credentials securely:

```bash
# ~/.bashrc or environment file
export FORCEPOINT_SMC_URL="https://smc.example.com:8082"
export FORCEPOINT_API_TOKEN="your-api-token-here"

# Use in scripts
SMC_URL=${FORCEPOINT_SMC_URL}
API_TOKEN=${FORCEPOINT_API_TOKEN}
```

---

## Basic API Operations

### 1. System Information

```python
def get_system_info():
    """Get SMC system information"""
    url = f"{SMC_URL}/api/v6/system/info"
    response = requests.get(url, headers=headers)
    return response.json()

info = get_system_info()
print(f"SMC Version: {info.get('version')}")
print(f"System Name: {info.get('name')}")
```

### 2. List Existing Policies

```python
def list_policies():
    """List all firewall policies"""
    url = f"{SMC_URL}/api/v6/policy"
    response = requests.get(url, headers=headers)
    return response.json()

policies = list_policies()
for policy in policies.get('policy', []):
    print(f"Policy: {policy['name']} (ID: {policy['href']})")
```

### 3. Get Policy Details

```python
def get_policy_details(policy_id):
    """Get detailed policy information"""
    url = f"{SMC_URL}/api/v6/policy/{policy_id}"
    response = requests.get(url, headers=headers)
    return response.json()

# Example usage
policy_id = "http://smc.example.com:8082/api/v6/policy/123"
details = get_policy_details(policy_id)
print(f"Policy Name: {details['name']}")
print(f"Rule Count: {len(details.get('rule', []))}")
```

---

## Policy Management

### 1. Create New Policy

```python
def create_policy(policy_name, policy_config):
    """Create a new firewall policy"""
    url = f"{SMC_URL}/api/v6/policy"
    
    payload = {
        "name": policy_name,
        "policy": policy_config
    }
    
    response = requests.post(url, headers=headers, json=payload)
    
    if response.status_code == 201:
        return response.json()
    else:
        raise Exception(f"Failed to create policy: {response.text}")

# Example: Deploy Capirca-generated policy
import json

with open('output/web-access.forcepoint.json', 'r') as f:
    policy_config = json.load(f)

result = create_policy('web-access-generated', policy_config)
print(f"Policy created: {result['href']}")
```

### 2. Update Existing Policy

```python
def update_policy(policy_id, policy_config):
    """Update an existing firewall policy"""
    url = f"{SMC_URL}/api/v6/policy/{policy_id}"
    
    response = requests.put(url, headers=headers, json=policy_config)
    
    if response.status_code == 200:
        return response.json()
    else:
        raise Exception(f"Failed to update policy: {response.text}")
```

### 3. Delete Policy

```python
def delete_policy(policy_id):
    """Delete a firewall policy"""
    url = f"{SMC_URL}/api/v6/policy/{policy_id}"
    
    response = requests.delete(url, headers=headers)
    
    if response.status_code == 204:
        print(f"Policy {policy_id} deleted successfully")
    else:
        raise Exception(f"Failed to delete policy: {response.text}")
```

---

## Object Management

### 1. Create Network Objects

```python
def create_network_object(name, ip_address, object_type='network'):
    """Create network object (host or network)"""
    url = f"{SMC_URL}/api/v6/elements/network"
    
    if '/' in ip_address:
        # Network object
        payload = {
            "name": name,
            "network": ip_address
        }
    else:
        # Host object
        payload = {
            "name": name,
            "address": ip_address
        }
    
    response = requests.post(url, headers=headers, json=payload)
    
    if response.status_code == 201:
        return response.json()
    else:
        raise Exception(f"Failed to create network object: {response.text}")

# Example usage
create_network_object('INTERNAL_NET', '10.0.0.0/8')
create_network_object('WEB_SERVER_01', '192.168.100.10')
```

### 2. Create Service Objects

```python
def create_service_object(name, protocol, port):
    """Create TCP/UDP service object"""
    url = f"{SMC_URL}/api/v6/elements/tcp_service"  # or udp_service
    
    payload = {
        "name": name,
        "protocol": protocol,  # 'tcp' or 'udp'
        "port": port
    }
    
    response = requests.post(url, headers=headers, json=payload)
    
    if response.status_code == 201:
        return response.json()
    else:
        raise Exception(f"Failed to create service object: {response.text}")

# Example usage
create_service_object('HTTP', 'tcp', 80)
create_service_object('HTTPS', 'tcp', 443)
create_service_object('DNS', 'udp', 53)
```

### 3. Create Object Groups

```python
def create_network_group(name, members):
    """Create network group with member objects"""
    url = f"{SMC_URL}/api/v6/elements/network_group"
    
    payload = {
        "name": name,
        "element": members  # List of object references
    }
    
    response = requests.post(url, headers=headers, json=payload)
    
    if response.status_code == 201:
        return response.json()
    else:
        raise Exception(f"Failed to create network group: {response.text}")

# Example usage
members = [
    "http://smc.example.com:8082/api/v6/elements/host/123",
    "http://smc.example.com:8082/api/v6/elements/host/124"
]
create_network_group('WEBSERVERS', members)
```

---

## Advanced Use Cases

### Use Case 1: Automated Policy Deployment Pipeline

```yaml
# .github/workflows/deploy-firewall.yml
name: Deploy Firewall Policy

on:
  push:
    paths:
      - 'policies/**'
      - 'def/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'
          
      - name: Install Capirca
        run: |
          pip install -r requirements.txt
          
      - name: Generate Policies
        run: |
          python capirca/aclgen.py --definitions def/ --output_dir output/
          
      - name: Deploy to Forcepoint
        env:
          SMC_URL: ${{ secrets.FORCEPOINT_SMC_URL }}
          API_TOKEN: ${{ secrets.FORCEPOINT_API_TOKEN }}
        run: |
          for policy in output/*.forcepoint.json; do
            curl -X POST "${SMC_URL}/api/v6/policy" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${API_TOKEN}" \
              -d @"$policy"
          done
```

### Use Case 2: Policy Validation and Testing

```python
def validate_policy(policy_file):
    """Validate generated policy before deployment"""
    import json
    
    with open(policy_file, 'r') as f:
        policy = json.load(f)
    
    # Basic validation checks
    errors = []
    
    # Check required fields
    if 'policy' not in policy:
        errors.append("Missing 'policy' root element")
        
    if 'name' not in policy['policy']:
        errors.append("Missing policy name")
        
    if 'rules' not in policy['policy']:
        errors.append("Missing rules section")
    
    # Validate each rule
    for i, rule in enumerate(policy['policy'].get('rules', [])):
        if 'name' not in rule:
            errors.append(f"Rule {i}: Missing name")
            
        if 'action' not in rule:
            errors.append(f"Rule {i}: Missing action")
            
        if 'sources' not in rule or 'destinations' not in rule:
            errors.append(f"Rule {i}: Missing sources or destinations")
    
    return errors

# Usage
errors = validate_policy('output/web-access.forcepoint.json')
if errors:
    print("Policy validation failed:")
    for error in errors:
        print(f"  - {error}")
    sys.exit(1)
else:
    print("Policy validation passed")
```

### Use Case 3: Multi-Firewall Policy Synchronization

```python
def sync_policy_to_firewalls(policy_file, firewall_list):
    """Deploy policy to multiple firewalls"""
    import json
    
    with open(policy_file, 'r') as f:
        policy_config = json.load(f)
    
    results = []
    
    for firewall in firewall_list:
        print(f"Deploying to {firewall['name']}...")
        
        try:
            # Create policy for this firewall
            policy_name = f"{policy_config['policy']['name']}-{firewall['name']}"
            result = create_policy(policy_name, policy_config)
            
            # Associate policy with firewall
            associate_policy_with_firewall(result['href'], firewall['id'])
            
            results.append({
                'firewall': firewall['name'],
                'status': 'success',
                'policy_id': result['href']
            })
            
        except Exception as e:
            results.append({
                'firewall': firewall['name'],
                'status': 'failed',
                'error': str(e)
            })
    
    return results

# Example usage
firewalls = [
    {'name': 'fw-datacenter-01', 'id': 'fw-001'},
    {'name': 'fw-datacenter-02', 'id': 'fw-002'},
    {'name': 'fw-branch-01', 'id': 'fw-003'}
]

results = sync_policy_to_firewalls('output/web-access.forcepoint.json', firewalls)
for result in results:
    print(f"{result['firewall']}: {result['status']}")
```

### Use Case 4: Policy Backup and Restore

```python
def backup_all_policies():
    """Backup all firewall policies"""
    policies = list_policies()
    backup_dir = f"backup/{datetime.now().strftime('%Y%m%d_%H%M%S')}"
    
    os.makedirs(backup_dir, exist_ok=True)
    
    for policy in policies.get('policy', []):
        policy_id = policy['href'].split('/')[-1]
        policy_name = policy['name']
        
        # Get policy details
        details = get_policy_details(policy_id)
        
        # Save to file
        filename = f"{backup_dir}/{policy_name}.json"
        with open(filename, 'w') as f:
            json.dump(details, f, indent=2)
        
        print(f"Backed up: {policy_name}")
    
    return backup_dir

def restore_policy_from_backup(backup_file):
    """Restore policy from backup file"""
    with open(backup_file, 'r') as f:
        policy_config = json.load(f)
    
    policy_name = policy_config['name']
    
    # Create new policy from backup
    result = create_policy(f"{policy_name}-restored", policy_config)
    print(f"Restored policy: {result['href']}")
    
    return result
```

---

## Error Handling

### Common HTTP Status Codes

| Status Code | Description | Action |
|-------------|-------------|--------|
| 200 | Success | Operation completed |
| 201 | Created | Resource created successfully |
| 400 | Bad Request | Invalid request format |
| 401 | Unauthorized | Invalid API token |
| 403 | Forbidden | Insufficient permissions |
| 404 | Not Found | Resource doesn't exist |
| 409 | Conflict | Resource already exists |
| 422 | Unprocessable Entity | Validation error |
| 500 | Internal Server Error | SMC error |

### Error Response Format

```json
{
  "error": {
    "code": 400,
    "message": "Invalid policy format",
    "details": "Missing required field: action"
  }
}
```

### Robust Error Handling

```python
import time
from requests.exceptions import RequestException

def api_call_with_retry(url, method='GET', max_retries=3, **kwargs):
    """API call with retry logic"""
    for attempt in range(max_retries):
        try:
            response = requests.request(method, url, headers=headers, **kwargs)
            
            if response.status_code in [200, 201, 204]:
                return response
            
            # Handle rate limiting
            if response.status_code == 429:
                retry_after = int(response.headers.get('Retry-After', 5))
                print(f"Rate limited. Waiting {retry_after} seconds...")
                time.sleep(retry_after)
                continue
            
            # Handle client errors (4xx) - don't retry
            if 400 <= response.status_code < 500:
                error_data = response.json() if response.content else {}
                raise Exception(f"API Error ({response.status_code}): {error_data.get('message', 'Unknown error')}")
            
            # Handle server errors (5xx) - retry
            if 500 <= response.status_code < 600:
                if attempt < max_retries - 1:
                    wait_time = 2 ** attempt  # Exponential backoff
                    print(f"Server error. Retrying in {wait_time} seconds...")
                    time.sleep(wait_time)
                    continue
            
        except RequestException as e:
            if attempt < max_retries - 1:
                wait_time = 2 ** attempt
                print(f"Network error. Retrying in {wait_time} seconds: {e}")
                time.sleep(wait_time)
                continue
            else:
                raise
    
    raise Exception(f"API call failed after {max_retries} attempts")
```

---

## Best Practices

### 1. Security

* **Secure API Keys**: Store API tokens in environment variables or vault systems
* **Least Privilege**: Use API accounts with minimum required permissions
* **HTTPS Only**: Always use HTTPS for API communications
* **IP Whitelisting**: Restrict API access to specific IP addresses

### 2. Performance

* **Batch Operations**: Group multiple operations in single API calls when possible
* **Pagination**: Use pagination for large result sets
* **Caching**: Cache frequently accessed objects (networks, services)
* **Rate Limiting**: Implement client-side rate limiting

### 3. Reliability

* **Idempotency**: Design operations to be idempotent where possible
* **Transaction Safety**: Use SMC's transaction capabilities for complex operations
* **Rollback Plans**: Always have rollback procedures for policy changes
* **Testing**: Test policies in non-production environments first

### 4. Monitoring

* **Logging**: Log all API operations with timestamps and results
* **Metrics**: Track API success rates, response times, and error patterns
* **Alerting**: Set up alerts for API failures or unusual activity
* **Auditing**: Maintain audit trails for compliance requirements

### 5. Code Organization

```python
# forcepoint_client.py - Reusable API client
class ForcepointClient:
    def __init__(self, smc_url, api_token):
        self.smc_url = smc_url
        self.api_token = api_token
        self.headers = {
            'Content-Type': 'application/json',
            'Authorization': f'Bearer {api_token}'
        }
    
    def create_policy(self, name, config):
        """Create policy with error handling"""
        pass
    
    def get_policy(self, policy_id):
        """Get policy with error handling"""
        pass
    
    def update_policy(self, policy_id, config):
        """Update policy with error handling"""
        pass

# Usage
client = ForcepointClient(
    smc_url=os.environ['FORCEPOINT_SMC_URL'],
    api_token=os.environ['FORCEPOINT_API_TOKEN']
)
```

---

## Troubleshooting

### Common Issues and Solutions

#### 1. Authentication Failures

**Problem**: 401 Unauthorized errors
**Solutions**:
- Verify API token is valid and not expired
- Check token permissions
- Ensure correct token format in Authorization header

#### 2. Network Connectivity Issues

**Problem**: Connection timeouts or refused connections
**Solutions**:
- Verify SMC URL and port (default: 8082)
- Check firewall rules allow HTTPS to SMC
- Verify DNS resolution of SMC hostname

#### 3. Policy Validation Errors

**Problem**: 422 Unprocessable Entity
**Solutions**:
- Validate JSON syntax before sending
- Check required fields are present
- Verify object references exist
- Review SMC logs for detailed error messages

#### 4. Object Reference Issues

**Problem**: Policies referencing non-existent objects
**Solutions**:
- Create objects before creating policies
- Use consistent naming conventions
- Verify object HREFs are correct

### Debugging Tools

#### 1. API Testing with curl

```bash
# Test authentication
curl -v -H "Authorization: Bearer $API_TOKEN" \
  "https://smc.example.com:8082/api/v6/system/info"

# Test policy creation with verbose output
curl -v -X POST "https://smc.example.com:8082/api/v6/policy" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $API_TOKEN" \
  -d @test-policy.json
```

#### 2. Python Debugging

```python
import logging
import requests

# Enable debug logging
logging.basicConfig(level=logging.DEBUG)
logging.getLogger("requests").setLevel(logging.DEBUG)

# This will show detailed HTTP request/response information
response = requests.get(url, headers=headers)
```

#### 3. SMC Log Analysis

```python
def get_smc_logs(severity='error', limit=100):
    """Get SMC logs for debugging"""
    url = f"{SMC_URL}/api/v6/log"
    
    params = {
        'severity': severity,
        'limit': limit
    }
    
    response = requests.get(url, headers=headers, params=params)
    return response.json()

# Get recent error logs
logs = get_smc_logs('error', 50)
for log in logs.get('log', []):
    print(f"{log['timestamp']}: {log['message']}")
```

### Performance Optimization

#### 1. Connection Pooling

```python
import requests.adapters

# Configure session with connection pooling
session = requests.Session()
adapter = requests.adapters.HTTPAdapter(
    pool_connections=10,
    pool_maxsize=20,
    max_retries=3
)
session.mount('https://', adapter)

# Use session for all requests
response = session.get(url, headers=headers)
```

#### 2. Asynchronous Operations

```python
import asyncio
import aiohttp

async def deploy_policy_async(policy_file):
    """Deploy policy asynchronously"""
    async with aiohttp.ClientSession() as session:
        with open(policy_file, 'r') as f:
            policy_config = json.load(f)
        
        async with session.post(
            f"{SMC_URL}/api/v6/policy",
            headers=headers,
            json=policy_config
        ) as response:
            return await response.json()

# Usage
async def main():
    result = await deploy_policy_async('policy.json')
    print(f"Policy deployed: {result}")

asyncio.run(main())
```

---

## Conclusion

This guide provides comprehensive coverage of Forcepoint REST API integration with Capirca. By following these examples and best practices, you can effectively automate firewall policy management and integrate it into your existing workflows.

### Next Steps

1. **Set up Development Environment**: Configure SMC and obtain API credentials
2. **Create Test Policies**: Start with simple policies and gradually increase complexity
3. **Implement CI/CD Integration**: Automate policy deployment in your pipeline
4. **Monitor and Optimize**: Track performance and implement improvements
5. **Scale Deployment**: Extend to multiple firewalls and complex scenarios

### Additional Resources

* [Forcepoint REST API Documentation](https://help.forcepoint.com/dlp/90/restapi/index.html)
* [Forcepoint SMC Python SDK](https://github.com/Forcepoint/fp-NGFW-SMC-python)
* [Capirca Documentation](https://github.com/google/capirca)
* [Forcepoint Community Forums](https://community.forcepoint.com/)

---

**Version**: 1.0  
**Last Updated**: 2024-11-24  
**Compatible with**: Forcepoint NGFW 6.x/7.x, Capirca 1.0+